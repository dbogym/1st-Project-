<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>404_COFFEE Not Found</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
  <style>
    /* 기존 스타일 유지 */
    .navbar {
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 10px 0;
      background-color: #343a40 !important;
    }

    .navbar-brand img {
      height: 50px;
      transition: transform 0.3s ease;
    }

    .navbar-brand img:hover {
      transform: scale(1.05);
    }

    .product-img {
      height: 200px;
      object-fit: cover;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
    }

    .product-card {
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }

    .product-card:hover {
      transform: translateY(-5px);
    }

    .product-title {
      font-size: 1.1rem;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-category {
      color: #6c757d;
      font-size: 0.9rem;
    }

    .product-price {
      font-weight: bold;
      color: #0d6efd;
    }

    .summary {
      background-color: #fff;
      padding: 25px;
      border-radius: 1rem;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1100;
    }

    body {
      background: #f8f9fa;
      font-family: 'Noto Sans KR', sans-serif;
    }

    @keyframes logoEntry {
      0% {
        transform: scale(4);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .logo-entry {
      animation: logoEntry 0.5s ease-out;
    }
  </style>
</head>
<body>
<!-- 네비게이션 바 -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="#">
      <img id="main-logo" src="/images/logo.png" alt="404_COFFEE" class="logo-entry">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <button id="admin-btn" class="btn btn-outline-light">관리자 페이지</button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- 메인 컨텐츠 -->
<div class="container my-5">
  <div class="row">
    <!-- 상품 목록 -->
    <div class="col-lg-8">
      <h2 class="mb-4 fw-bold">상품목록</h2>
      <div class="row" id="product-list"></div>
    </div>

    <!-- 주문 요약 -->
    <div class="col-lg-4">
      <div class="summary sticky-top" style="top: 20px;">
        <h4 class="mb-3 fw-bold"><i class="bi bi-cart3"></i> 주문 요약</h4>
        <hr>
        <div id="summary-list"></div>
        <form id="order-form" class="mt-4">
          <div class="mb-3">
            <label for="email" class="form-label">이메일</label>
            <input type="email" class="form-control" id="email" required>
          </div>
          <div class="mb-3">
            <label for="address" class="form-label">주소</label>
            <input type="text" class="form-control" id="address" required>
          </div>
          <div class="mb-3">
            <label for="postCode" class="form-label">우편번호</label>
            <input type="text" class="form-control" id="postCode" required>
          </div>
        </form>
        <div class="row pt-2 pb-2 border-top">
          <h5 class="col fw-bold">총금액</h5>
          <h5 class="col text-end fw-bold" id="total-price">0원</h5>
        </div>
        <button id="checkout-btn" class="btn btn-dark w-100 mt-2 py-2 fw-bold">결제하기</button>
      </div>
    </div>
  </div>
</div>

<!-- 토스트 알림 -->
<div class="toast-container"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const cart = {};

  // 상품 목록 조회
  async function fetchProducts() {
    try {
      const response = await fetch('/items');
      if (!response.ok) throw new Error('상품 조회 실패');
      return await response.json();
    } catch (error) {
      showToast(error.message, 'danger');
      return [];
    }
  }

  // 상품 렌더링
  async function renderProducts() {
    const products = await fetchProducts();
    const container = document.getElementById('product-list');
    container.innerHTML = products.map(item => `
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card h-100">
            <img src="${item.imageUrl}" class="card-img-top product-img" alt="${item.name}">
            <div class="card-body">
              <h5 class="card-title">${item.name}</h5>
              <p class="text-muted">${item.desc}</p>
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold">${item.price.toLocaleString()}원</span>
                <span class="badge bg-secondary">재고: ${item.stock}</span>
                <button onclick="addToCart('${item.id}')" class="btn btn-sm btn-primary" ${item.stock <= 0 ? 'disabled' : ''}>
                  ${item.stock <= 0 ? '품절' : '담기'}
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
  }

  // 장바구니 추가
  async function addToCart(itemId) {
    try {
      const response = await fetch(`/items/${itemId}`);
      if (!response.ok) throw new Error('상품 조회 실패');
      const item = await response.json();

      if (item.stock <= 0) throw new Error('품절된 상품입니다');

      // 기존에 있는 상품인지 확인
      if (cart[itemId]) {
        // 재고 확인
        if (cart[itemId].quantity >= item.stock) {
          throw new Error('재고가 부족합니다');
        }
        cart[itemId].quantity += 1;
      } else {
        cart[itemId] = { ...item, quantity: 1 };
      }

      updateSummary();
      showToast(`${item.name}이 장바구니에 추가되었습니다`);
    } catch (error) {
      showToast(error.message, 'danger');
    }
  }

  // 주문 요약 업데이트
  function updateSummary() {
    const container = document.getElementById('summary-list');
    const totalElement = document.getElementById('total-price');
    let total = 0;

    container.innerHTML = Object.keys(cart).map(key => {
      const item = cart[key];
      const subtotal = item.price * item.quantity;
      total += subtotal;
      return `
          <div class="d-flex justify-content-between mb-2">
            <div>
              <h6>${item.name}</h6>
              <small>${item.price.toLocaleString()}원 × ${item.quantity}</small>
            </div>
            <div>
              <button onclick="changeQuantity('${item.id}', ${item.quantity - 1})" class="btn btn-sm btn-outline-secondary">-</button>
              <span class="mx-2">${item.quantity}</span>
              <button onclick="changeQuantity('${item.id}', ${item.quantity + 1})" class="btn btn-sm btn-outline-secondary" ${item.quantity >= item.stock ? 'disabled' : ''}>+</button>
              <button onclick="removeFromCart('${item.id}')" class="btn btn-sm btn-outline-danger ms-2">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        `;
    }).join('');

    totalElement.textContent = `${total.toLocaleString()}원`;
  }

  // 결제 처리
  document.getElementById('checkout-btn').addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const address = document.getElementById('address').value;
    const postCode = document.getElementById('postCode').value;

    if (!email || !address || !postCode) {
      showToast('모든 정보를 입력해주세요', 'danger');
      return;
    }

    if (Object.keys(cart).length === 0) {
      showToast('장바구니가 비어있습니다', 'danger');
      return;
    }

    try {
      // 주문 생성
      const orderResponse = await fetch('/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email,
          address,
          postCode,
          orderItemList: Object.keys(cart).map(key => ({
            itemId: cart[key].id,
            quantity: cart[key].quantity,
            price: cart[key].price
          })),
          totalPrice: Object.keys(cart).reduce((sum, key) => sum + (cart[key].price * cart[key].quantity), 0)
        })
      });

      if (!orderResponse.ok) throw new Error('주문 실패');

      // 재고 업데이트
      await Promise.all(Object.keys(cart).map(key =>
              fetch(`/items/${cart[key].id}/stock`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: cart[key].quantity })
              })
      ));

      showToast('주문이 완료되었습니다!', 'success');
      // 장바구니 비우기
      for (const key in cart) {
        delete cart[key];
      }
      updateSummary();
      document.getElementById('order-form').reset();
      renderProducts();
    } catch (error) {
      showToast(error.message || '결제 실패', 'danger');
    }
  });

  // 기타 유틸리티 함수
  function changeQuantity(itemId, newQuantity) {
    if (newQuantity <= 0) {
      delete cart[itemId];
    } else {
      // 재고 확인
      if (newQuantity > cart[itemId].stock) {
        showToast('재고가 부족합니다', 'danger');
        return;
      }
      cart[itemId].quantity = newQuantity;
    }
    updateSummary();
  }

  function removeFromCart(itemId) {
    delete cart[itemId];
    updateSummary();
  }

  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast show align-items-center text-white bg-${type}`;
    toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
    document.querySelector('.toast-container').appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // 초기화
  document.addEventListener('DOMContentLoaded', renderProducts);
  document.getElementById('admin-btn').addEventListener('click', () => {
    window.location.href = '/admin';
  });
</script>
</body>
</html>