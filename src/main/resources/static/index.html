<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>404_COFFEE Not Found</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
  <style>
    /* 기존 스타일 유지 */
    .navbar {
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 10px 0;
      background-color: #343a40 !important;
    }
    
    .navbar-brand img {
      height: 50px;
      transition: transform 0.3s ease;
    }
    
    .navbar-brand img:hover {
      transform: scale(1.05);
    }
    
    .product-img {
      height: 200px;
      object-fit: cover;
      border-top-left-radius: 1rem;
      border-top-right-radius: 1rem;
    }
    
    .product-card {
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
    }
    
    .product-title {
      font-size: 1.1rem;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .product-category {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .product-price {
      font-weight: bold;
      color: #0d6efd;
    }
    
    .summary {
      background-color: #fff;
      padding: 25px;
      border-radius: 1rem;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }
    
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1100;
    }
    
    body {
      background: #f8f9fa;
      font-family: 'Noto Sans KR', sans-serif;
    }
    
    @keyframes logoEntry {
      0% {
        transform: scale(4);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .logo-entry {
      animation: logoEntry 0.5s ease-out;
    }
  </style>
</head>
<body>
  <!-- 네비게이션 바 -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">
        <img id="main-logo" src="../../../../../../../../NBE5-7-1-Team01-origin-feat-4-frontend-newname99/src/main/resources/templates/fetch/storage_image/Logo.png" alt="404_COFFEE Not Found" class="logo-entry">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <button id="admin-btn" class="btn btn-outline-light">관리자 페이지</button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- 메인 컨텐츠 -->
  <div class="container my-5">
    <div class="row">
      <!-- 상품 목록 섹션 -->
      <div class="col-lg-8">
        <h2 class="mb-4 fw-bold">상품목록</h2>
        <div class="row" id="product-list">
          <!-- 상품 카드들이 여기에 동적으로 로드됩니다 -->
        </div>
      </div>

      <!-- 주문 요약 -->
      <div class="col-lg-4">
        <div class="summary sticky-top" style="top: 20px;">
          <h4 class="mb-3 fw-bold"><i class="bi bi-cart3"></i> 주문 요약</h4>
          <hr>
          <div id="summary-list"></div>

          <form id="order-form" class="mt-4">
            <div class="mb-3">
              <label for="email" class="form-label">이메일</label>
              <input type="email" class="form-control mb-1" id="email" required>
            </div>
            <div class="mb-3">
              <label for="address" class="form-label">주소</label>
              <input type="text" class="form-control mb-1" id="address" required>
            </div>
            <div class="mb-3">
              <label for="postcode" class="form-label">우편번호</label>
              <input type="text" class="form-control" id="postcode" required>
            </div>
            <div class="text-muted mb-3 small">당일 오후 2시 이후의 주문은 다음날 배송을 시작합니다.</div>
          </form>

          <div class="row pt-2 pb-2 border-top">
            <h5 class="col fw-bold">총금액</h5>
            <h5 class="col text-end fw-bold" id="total-price">0원</h5>
          </div>
          <button id="checkout-btn" class="btn btn-dark w-100 mt-2 py-2 fw-bold">결제하기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 토스트 알림 컨테이너 -->
  <div class="toast-container"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // 장바구니 객체
    const cart = {};

    // 상품 목록을 백엔드에서 가져오기
    async function fetchProducts() {
      try {
        const response = await fetch('/api/items');
        if (!response.ok) {
          throw new Error('상품 목록을 불러오는데 실패했습니다.');
        }
        return await response.json();
      } catch (error) {
        console.error('Error:', error);
        showToast('상품 목록을 불러오는데 실패했습니다.', 'danger');
        return [];
      }
    }

    // 상품 렌더링 함수
    async function renderProducts() {
      const products = await fetchProducts();
      const productList = document.getElementById("product-list");
      productList.innerHTML = "";
      
      products.forEach((product, index) => {
        const col = document.createElement("div");
        col.className = "col-md-6 col-lg-4 product-card";
        col.innerHTML = `
          <div class="card h-100 border-0 shadow-sm">
            <img src="${product.imageUrl}" class="card-img-top product-img" alt="${product.name}" loading="lazy">
            <div class="card-body">
              <span class="product-category">${product.category}</span>
              <h5 class="card-title product-title mt-1">${product.name}</h5>
              <p class="card-text text-muted small">${product.description}</p>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <span class="product-price">${product.price.toLocaleString()}원</span>
                <button class="btn btn-primary btn-sm" onclick="addToCart(${product.id})">
                  <i class="bi bi-cart-plus"></i> 추가
                </button>
              </div>
            </div>
          </div>
        `;
        productList.appendChild(col);
      });
    }

    // 장바구니 추가 함수
    function addToCart(productId) {
      fetch(`/api/items/${productId}`)
        .then(response => response.json())
        .then(product => {
          cart[product.id] = cart[product.id]
            ? { ...product, quantity: cart[product.id].quantity + 1 }
            : { ...product, quantity: 1 };
          updateSummary();
          showToast(`${product.name}이(가) 장바구니에 추가되었습니다.`);
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('상품을 장바구니에 추가하는데 실패했습니다.', 'danger');
        });
    }

    // 장바구니에서 제거 함수
    function removeFromCart(productId) {
      const productName = cart[productId]?.name || '';
      delete cart[productId];
      updateSummary();
      showToast(`${productName}이(가) 장바구니에서 제거되었습니다.`, 'danger');
    }

    // 수량 변경 함수
    function changeQuantity(productId, value) {
      const quantity = parseInt(value);
      if (!isNaN(quantity)) {
        if (quantity > 0) {
          cart[productId].quantity = quantity;
        } else {
          delete cart[productId];
        }
        updateSummary();
      }
    }

    // 주문 요약 업데이트 함수
    function updateSummary() {
      const summaryList = document.getElementById("summary-list");
      const totalPrice = document.getElementById("total-price");
      summaryList.innerHTML = "";
      let total = 0;

      Object.values(cart).forEach(item => {
        total += items.price * items.quantity;
        const row = document.createElement("div");
        row.className = "row justify-content-between align-items-center mb-2";
        row.innerHTML = `
          <div class="col">
            <h6 class="p-0 m-0">${items.name}</h6>
            <small class="text-muted">${items.price.toLocaleString()}원 × ${items.quantity}</small>
          </div>
          <div class="col-auto">
            <input type="number" class="form-control form-control-sm" min="1" value="${items.quantity}" style="width: 60px;"
              onchange="changeQuantity('${items.id}', this.value)">
          </div>
          <div class="col-auto">
            <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart('${items.id}')">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;
        summaryList.appendChild(row);
      });

      totalPrice.textContent = `${total.toLocaleString()}원`;
    }

    // 주문 처리 함수
    document.getElementById('checkout-btn').addEventListener('click', async function() {
      const email = document.getElementById('email').value;
      const address = document.getElementById('address').value;
      const postcode = document.getElementById('postcode').value;
      
      if (!email || !address || !postcode) {
        showToast('모든 필드를 입력해주세요.', 'danger');
        return;
      }

      if (Object.keys(cart).length === 0) {
        showToast('장바구니가 비어 있습니다.', 'danger');
        return;
      }

      const orderItems = Object.values(cart).map(item => ({
        itemId: items.id,
        quantity: items.quantity,
        price: items.price
      }));

      try {
        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email,
            address,
            postCode: postcode,
            orderItems
          })
        });

        if (!response.ok) {
          throw new Error('주문 처리에 실패했습니다.');
        }

        const result = await response.json();
        showToast('주문이 완료되었습니다!', 'success');
        
        // 장바구니 비우기
        Object.keys(cart).forEach(key => delete cart[key]);
        updateSummary();
        document.getElementById('order-form').reset();
      } catch (error) {
        console.error('Error:', error);
        showToast('주문 처리에 실패했습니다.', 'danger');
      }
    });

    // 토스트 알림 표시 함수
    function showToast(message, type = 'success') {
      const toastContainer = document.querySelector('.toast-container');
      const toastId = `toast-${Date.now()}`;
      
      const toast = document.createElement('div');
      toast.className = `toast show align-items-center text-white bg-${type}`;
      toast.role = 'alert';
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // 3초 후 자동으로 제거
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // 관리자 페이지로 이동
    document.getElementById('admin-btn').addEventListener('click', function() {
      window.location.href = "admin/admin.html";
    });

    // 페이지 로드 시 상품 렌더링
    document.addEventListener('DOMContentLoaded', renderProducts);
  </script>
</body>
</html>